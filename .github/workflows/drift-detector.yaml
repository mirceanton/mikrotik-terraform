---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Terragrunt Drift Detection
permissions: { contents: read }

on:
  workflow_dispatch: {}
  schedule: [{ cron: "0 0/2 * * *" }] # Every 2 hours

env:
  ISSUE_TITLE: "⚠️ Terragrunt Drift Detected ⚠️"

  # Terragrunt Vars
  MIKROTIK_USERNAME: "${{ secrets.MIKROTIK_USERNAME }}"
  MIKROTIK_PASSWORD: "${{ secrets.MIKROTIK_PASSWORD }}"
  PPPOE_USERNAME: "${{ secrets.PPPOE_USERNAME }}"
  PPPOE_PASSWORD: "${{ secrets.PPPOE_PASSWORD }}"
  CLOUDFLARE_API_TOKEN: "${{ secrets.CLOUDFLARE_API_TOKEN }}"
  ZEROTIER_CENTRAL_TOKEN: "${{ secrets.ZEROTIER_CENTRAL_TOKEN }}"
  AWS_ACCESS_KEY_ID: "${{ secrets.AWS_ACCESS_KEY_ID }}"
  AWS_SECRET_ACCESS_KEY: "${{ secrets.AWS_SECRET_ACCESS_KEY }}"

jobs:
  terragrunt-drift:
    runs-on: [self-hosted, infra]
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Generate Token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        id: app-token
        with:
          app-id: '${{ secrets.BOT_APP_ID }}'
          private-key: '${{ secrets.BOT_APP_PRIVATE_KEY }}'

      - name: Setup mise
        uses: jdx/mise-action@e3d7b8d67a7958d1207f6ed871e83b1ea780e7b0 # v3.3.1

      - name: Terragrunt Init
        run: terragrunt init --all -upgrade

      - name: Terragrunt Plan
        run: |
          terragrunt plan --all --detailed-exitcode -no-color 2>&1 | tee plan_output.txt
          if [ "${PIPESTATUS[0]}" -eq 2 ]; then
            echo "DRIFT_DETECTED=true" | tee "$GITHUB_ENV"
          else
            echo "DRIFT_DETECTED=false" | tee "$GITHUB_ENV"
          fi

      - name: Open Issue if Drift Detected
        if: env.DRIFT_DETECTED == 'true'
        env:
          GITHUB_TOKEN: '${{ steps.app-token.outputs.token }}'
        run: |
          ISSUE_NUMBER=$(gh issue list --state "all" --search "$ISSUE_TITLE" --json "number" --jq ".[0].number")
          if [ -n "$ISSUE_NUMBER" ]; then
            gh issue reopen "$ISSUE_NUMBER"
          else
            gh issue create --title "$ISSUE_TITLE" --body ""
            sleep 3 # Wait for issue to be created
            ISSUE_NUMBER=$(gh issue list --state "all" --search "$ISSUE_TITLE" --json "number" --jq ".[0].number")
          fi
          
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          {
            echo "## ⚠️ **Drift detected in workflow run [#${{ github.run_number }}]($RUN_URL)**"
            echo ""
            echo "Run \`terragrunt apply --all\` to reconcile changes."
            echo ""
            echo "### Plan Output"
            echo "<details>"
            echo "<summary>Click to expand drift details</summary>"
            echo ""
            echo '```'
            cat plan_output.txt
            echo '```'
            echo ""
            echo "</details>"
          } > issue_body.txt
          gh issue edit "$ISSUE_NUMBER" --body-file issue_body.txt
          gh issue pin "$ISSUE_NUMBER"

      - name: Close GitHub Issue if No Drift
        if: env.DRIFT_DETECTED == 'false'
        env:
          GITHUB_TOKEN: '${{ steps.app-token.outputs.token }}'
          COMMENT: |
            ✅ No drift detected. Closing issue automatically.
            Verified in [workflow run #${{ github.run_number }}]("${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}").
        run: |
          ISSUE_NUMBER=$(gh issue list --state "open" --search "$ISSUE_TITLE" --json "number" --jq ".[0].number")
          echo "ISSUE_NUMBER is '$ISSUE_NUMBER'"
          if [ -n "$ISSUE_NUMBER" ]; then
            gh issue close "$ISSUE_NUMBER" --comment "$COMMENT"
            gh issue unpin "$ISSUE_NUMBER"
          fi
