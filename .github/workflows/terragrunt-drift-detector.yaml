---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Terragrunt Drift Detection
permissions: { contents: read }

on:
  workflow_dispatch: {}
  schedule: [{ cron: "0 0/2 * * *" }] # Every 2 hours

env:
  ISSUE_TITLE: "‚ö†Ô∏è Terragrunt Drift Detected ‚ö†Ô∏è"

jobs:
  terragrunt-plan:
    uses: ./.github/workflows/terragrunt-plan.yaml
    secrets:
      op-service-account-token: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

  issue-management:
    runs-on: ubuntu-latest
    needs: terragrunt-plan
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup mise
        uses: jdx/mise-action@9dc7d5dd454262207dea3ab5a06a3df6afc8ff26 # v3.4.1

      - name: Generate Token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        id: app-token
        with:
          app-id: "${{ secrets.BOT_APP_ID }}"
          private-key: "${{ secrets.BOT_APP_PRIVATE_KEY }}"

      - name: Open Issue if Drift Detected
        if: needs.terragrunt-plan.outputs.drift_detected == 'true'
        env:
          GITHUB_TOKEN: "${{ steps.app-token.outputs.token }}"
          PLAN_OUTPUT: "${{ needs.terragrunt-plan.outputs.plan_output }}"
        run: |
          ISSUE_NUMBER=$(gh issue list --state "all" --search "$ISSUE_TITLE" --json "number" --jq ".[0].number")
          if [ -n "$ISSUE_NUMBER" ]; then
            gh issue reopen "$ISSUE_NUMBER"
          else
            gh issue create --title "$ISSUE_TITLE" --body ""
            sleep 3 # Wait for issue to be created
            ISSUE_NUMBER=$(gh issue list --state "all" --search "$ISSUE_TITLE" --json "number" --jq ".[0].number")
          fi

          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/workflows/terragrunt-apply.yaml"
          {
            echo "## ‚ö†Ô∏è **Drift detected in workflow run [#${{ github.run_number }}]($RUN_URL)**"
            echo ""
            echo "### üöÄ Quick Actions"
            echo ""
            echo "[![Run Terragrunt Apply](${{ github.server_url }}/${{ github.repository }}/actions/workflows/terragrunt-apply.yml/badge.svg)]($WORKFLOW_URL)"
            echo ""
            echo "**[Click here to run Terragrunt Apply workflow]($WORKFLOW_URL)** (then click 'Run workflow' button)"
            echo ""
            echo "Or run manually: \`terragrunt apply --all\`"
            echo ""
            echo "### Plan Output"
            echo "<details>"
            echo "<summary>Click to expand drift details</summary>"
            echo ""
            echo '```'
            echo "$PLAN_OUTPUT"
            echo '```'
            echo ""
            echo "</details>"
          } > issue_body.txt
          gh issue edit "$ISSUE_NUMBER" --body-file issue_body.txt
          gh issue pin "$ISSUE_NUMBER"

      - name: Close GitHub Issue if No Drift
        if: needs.terragrunt-plan.outputs.drift_detected == 'false'
        env:
          GITHUB_TOKEN: "${{ steps.app-token.outputs.token }}"
          COMMENT: |
            ‚úÖ No drift detected. Closing issue automatically.
            Verified in [workflow run #${{ github.run_number }}]("${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}").
        run: |
          ISSUE_NUMBER=$(gh issue list --state "open" --search "$ISSUE_TITLE" --json "number" --jq ".[0].number")
          echo "ISSUE_NUMBER is '$ISSUE_NUMBER'"
          if [ -n "$ISSUE_NUMBER" ]; then
            gh issue close "$ISSUE_NUMBER" --comment "$COMMENT"
            gh issue unpin "$ISSUE_NUMBER"
          fi
